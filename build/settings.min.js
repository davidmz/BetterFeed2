(()=>{"use strict";function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var n=function(){function n(e){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n),this._value=e,this._listeners=new Set}var t,r,o;return t=n,o=[{key:"combine",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var o=new n(t.map((function(e){return e.value})));return t.forEach((function(e,n){return e.onValue((function(e){var t=o.value;t[n]=e,o.value=t}))})),o}},{key:"fromInput",value:function(e,t,r){if(!e||!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return new n(null);var o="value";e instanceof HTMLInputElement&&("checkbox"===e.type||"radio"===e.type)&&(o="checked");var i=t?t.split(" "):["input","change"];r=r||o;var u=function(){return"self"===r?e:e[r]},a=new n(u());return i.forEach((function(n){return e.addEventListener(n,(function(){return a.value=u()}))})),a}},{key:"ticker",value:function(e){var t=new n(!0);return setInterval((function(){return t.value=!0}),e),t}}],(r=[{key:"value",get:function(){return this._value},set:function(e){this._value=e,this.poke()}},{key:"poke",value:function(){var e=this;this._listeners.forEach((function(n){return n(e._value)}))}},{key:"onValue",value:function(e){return this._listeners.add(e),e(this.value),this}},{key:"unListen",value:function(e){return this._listeners.delete(e),this}},{key:"derive",value:function(e,t){var r=new n(t);return this.onValue((function(n){return e(r,n)})),r}},{key:"map",value:function(e){return this.derive((function(n,t){return n.value=e(t)}))}},{key:"filter",value:function(e){return this.derive((function(n,t){return e(t)&&(n.value=t)}))}},{key:"throttle",value:function(e){var n=this,t=void 0,r=null;return this.derive((function(o,i){t=i,r||(r=setTimeout((function(){void 0!==t&&(o.value=n.value,t=void 0),r=null}),e))}),this.value)}},{key:"latestPromise",value:function(e){var n=null;return this.derive((function(e,t){var r=t;n=r,r.then((function(t){r===n&&(e.value=t)}))}),e)}},{key:"distinct",value:function(){var e;return this.derive((function(n,t){t!==e&&(e=t,n.value=t)}))}}])&&e(t.prototype,r),o&&e(t,o),Object.defineProperty(t,"prototype",{writable:!1}),n}(),t="matches"in HTMLElement.prototype?"matches":"msMatchesSelector";const r=function(e,n,r){if(null===e)return[];var o=e.querySelectorAll(n),i=o?Array.prototype.slice.call(o):[];if(function(e,n){return e[t](n)}(e,n)&&i.unshift(e),r)for(var u=0,a=i.length;u<a;u++)r(i[u]);return i};var o=new Map;function i(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,o,i=[],u=!0,a=!1;try{for(t=t.call(e);!(u=(r=t.next()).done)&&(i.push(r.value),!n||i.length!==n);u=!0);}catch(e){a=!0,o=e}finally{try{u||null==t.return||t.return()}finally{if(a)throw o}}return i}}(e,n)||function(e,n){if(e){if("string"==typeof e)return u(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?u(e,n):void 0}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function a(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function l(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=function(){function e(){var n=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];a(this,e),this.modules=new Map,o.forEach((function(e){e.alwaysEnabled||n.modules.set(e.name,e.enabledByDefault)})),this.hideAliens=!1,this.commentCloudsMode=2,t&&((t.modules||[]).forEach((function(e){var t=i(e,2),o=t[0],u=t[1];(r||n.modules.has(o))&&n.modules.set(o,!!u)})),this.hideAliens=!!t.hideAliens,1!==t.commentCloudsMode&&2!==t.commentCloudsMode||(this.commentCloudsMode=t.commentCloudsMode))}var n,t;return n=e,(t=[{key:"toJSON",value:function(){var e={modules:[]};return this.modules.forEach((function(n,t){return e.modules.push([t,n])})),e.hideAliens=this.hideAliens,e.commentCloudsMode=this.commentCloudsMode,e}},{key:"isModuleEnabled",value:function(e){var n=this;return e&&(e.alwaysEnabled||!this.modules.has(e.name)&&e.enabledByDefault||this.modules.get(e.name))&&!e.requiredModules.map((function(e){return o.get(e)})).some((function(e){return!n.isModuleEnabled(e)}))}}])&&l(n.prototype,t),Object.defineProperty(n,"prototype",{writable:!1}),e}();function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function d(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function f(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var v=1,h="@response",m=function(){function e(){var n=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";d(this,e),this.__responders=new Map,this.__listeners=new Map,this.defaultWindow=t,this.defaultOrigin=r,window.addEventListener("message",(function(e){if("object"===c(e.data)){var t=e.data,r=t.action,o=t.requestId,i=t.value,u=e.source,a=e.origin;if(r===h&&n.__responders.has(o))n.__responders.get(o)(i),n.__responders.delete(o);else if(n.__listeners.has(r)){var l=n.__listeners.get(r)(i);u.postMessage({action:h,requestId:o,value:l},a)}}}))}var n,t;return n=e,t=[{key:"send",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.sendEx(this.defaultWindow,this.defaultOrigin,e,n)}},{key:"sendEx",value:function(e,n,t){var r=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new Promise((function(i){var u=v++;r.__responders.set(u,i),e.postMessage({action:t,requestId:u,value:o},n)}))}},{key:"on",value:function(e,n){this.__listeners.set(e,n)}}],t&&f(n.prototype,t),Object.defineProperty(n,"prototype",{writable:!1}),e}(),p=document.querySelector(".content.settings");if(p){var y=window.parent===window?window.opener:window.parent;y||alert("Пожалуйста, откройте эту страницу по ссылке из FreeFeed-а");var b=document.querySelector('meta[name="parentOrigin"]').content,g=document.querySelector('meta[name="betterFeedVersion"]').content,w=document.getElementById("save-settings"),k=document.getElementById("check-updates"),E=r(p,"input[type='checkbox']"),M=r(p,"input[name='comment-clouds-mode']"),_=new m(y,b),S=null;document.querySelector(".version").appendChild(document.createTextNode(g)),w.addEventListener("click",(function(){w.disabled=!0,w.style.width=w.offsetWidth+"px",w.innerHTML=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}("Сохраняем…"),E.forEach((function(e){return S.modules.set(e.id,e.checked)})),S.commentCloudsMode=parseInt(O(M)),_.send("saveSettings",S.toJSON())})),k.addEventListener("click",(function(e){var n=e.target;n.disabled=!0,_.send("checkUpdates").then((function(){return n.disabled=!1}))}));var I=new n(!1),A=new Map,L=function(){var e=new Map;return r(p,"input, textarea",(function(n){n.id&&e.set(n.id,"checkbox"===n.type?n.checked:n.value)})),e.set("comment-clouds-mode",O(M)),e};_.send("getSettings").then((function(e){var t,o;S=new s(e,!0),E.forEach((function(e){return e.checked=S.modules.get(e.id)})),t=M,o=S.commentCloudsMode,t.forEach((function(e){return e.checked=e.value==o})),r(p,"[data-disabled-if]",(function(e){var t=e.dataset.disabledIf,r=document.getElementById(t);r&&n.fromInput(r).onValue((function(n){return e.disabled=n}))})),r(p,"[data-enabled-if]",(function(e){var t=e.dataset.enabledIf,r=document.getElementById(t);r&&n.fromInput(r).onValue((function(n){return e.disabled=!n}))})),A=L(),p.classList.remove("hidden"),p.previousElementSibling.classList.add("hidden")}));var C=function(){var e=L(),n=!1;e.forEach((function(e,t){return n=n||e!==A.get(t)})),I.value=n};p.addEventListener("input",C),p.addEventListener("change",C),I.distinct().onValue((function(e){return w.disabled=!e}))}function O(e){return e.reduce((function(e,n){return n.checked?n.value:e}),null)}})();